<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConditionalTransformation.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">vtl-transform</a> &gt; <a href="index.source.html" class="el_package">it.bancaditalia.oss.vtl.impl.transform.ops</a> &gt; <span class="el_source">ConditionalTransformation.java</span></div><h1>ConditionalTransformation.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright 2020, Bank Of Italy
 *
 * Licensed under the EUPL, Version 1.2 (the &quot;License&quot;);
 * You may not use this work except in compliance with the
 * License.
 * You may obtain a copy of the License at:
 *
 * https://joinup.ec.europa.eu/sites/default/files/custom-page/attachment/2020-03/EUPL-1.2%20EN.txt
 *
 * Unless required by applicable law or agreed to in
 * writing, software distributed under the License is
 * distributed on an &quot;AS IS&quot; basis,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied.
 *
 * See the License for the specific language governing
 * permissions and limitations under the License.
 *******************************************************************************/
package it.bancaditalia.oss.vtl.impl.transform.ops;

import static it.bancaditalia.oss.vtl.impl.types.domain.Domains.BOOLEANDS;
import static it.bancaditalia.oss.vtl.util.Utils.toMapWithValues;
import static java.util.stream.Collectors.toSet;
import static java.util.stream.Stream.concat;

import java.util.HashSet;
import java.util.Map;
import java.util.Set;
import java.util.function.Function;

import it.bancaditalia.oss.vtl.exceptions.VTLMissingComponentsException;
import it.bancaditalia.oss.vtl.impl.transform.exceptions.VTLExpectedComponentException;
import it.bancaditalia.oss.vtl.impl.transform.exceptions.VTLSyntaxException;
import it.bancaditalia.oss.vtl.impl.types.domain.Domains;
import it.bancaditalia.oss.vtl.model.data.ComponentRole.Identifier;
import it.bancaditalia.oss.vtl.model.data.ComponentRole.Measure;
import it.bancaditalia.oss.vtl.model.data.ComponentRole.NonIdentifier;
import it.bancaditalia.oss.vtl.model.data.DataPoint;
import it.bancaditalia.oss.vtl.model.data.DataSet;
import it.bancaditalia.oss.vtl.model.data.DataSet.VTLDataSetMetadata;
import it.bancaditalia.oss.vtl.model.data.DataStructureComponent;
import it.bancaditalia.oss.vtl.model.data.ScalarValue;
import it.bancaditalia.oss.vtl.model.data.ScalarValue.VTLScalarValueMetadata;
import it.bancaditalia.oss.vtl.model.data.VTLValue;
import it.bancaditalia.oss.vtl.model.data.VTLValue.VTLValueMetadata;
import it.bancaditalia.oss.vtl.model.domain.BooleanDomain;
import it.bancaditalia.oss.vtl.model.domain.BooleanDomainSubset;
import it.bancaditalia.oss.vtl.model.transform.LeafTransformation;
import it.bancaditalia.oss.vtl.model.transform.Transformation;
import it.bancaditalia.oss.vtl.model.transform.TransformationScheme;

public class ConditionalTransformation extends TransformationImpl
{
	private static final long serialVersionUID = 1L;

	public ConditionalTransformation(Transformation condition, Transformation trueExpr, Transformation falseExpr)
<span class="nc" id="L58">	{</span>
<span class="nc" id="L59">		this.condition = condition;</span>
<span class="nc" id="L60">		this.thenExpr = trueExpr;</span>
<span class="nc" id="L61">		this.elseExpr = falseExpr;</span>
<span class="nc" id="L62">	}</span>

	private final Transformation	condition;
	private final Transformation	thenExpr, elseExpr;

	private VTLValueMetadata		metadata;

	@Override
	public VTLValue eval(TransformationScheme session)
	{
<span class="nc" id="L72">		VTLValue cond = condition.eval(session);</span>

<span class="nc bnc" id="L74" title="All 2 branches missed.">		if (metadata instanceof ScalarValue)</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">			return BOOLEANDS.cast((ScalarValue&lt;?, ?, ?&gt;) cond).get() </span>
<span class="nc" id="L76">					? thenExpr.eval(session)</span>
<span class="nc" id="L77">					: elseExpr.eval(session);</span>
		else // if (metadata instanceof VTLDataSetMetadata)
		{
<span class="nc" id="L80">			DataSet condD = (DataSet) cond;</span>
<span class="nc" id="L81">			Set&lt;DataStructureComponent&lt;Identifier, ?, ?&gt;&gt; keys = ((VTLDataSetMetadata) metadata).getComponents(Identifier.class);</span>
<span class="nc" id="L82">			VTLValue thenV = thenExpr.eval(session);</span>
<span class="nc" id="L83">			VTLValue elseV = elseExpr.eval(session);</span>
<span class="nc" id="L84">			DataStructureComponent&lt;Identifier, BooleanDomainSubset, BooleanDomain&gt; booleanConditionMeasure = condD.getComponents(Identifier.class, BOOLEANDS).iterator().next();</span>

			Function&lt;DataPoint, Map&lt;? extends DataStructureComponent&lt;? extends NonIdentifier, ?, ?&gt;, ? extends ScalarValue&lt;?, ?, ?&gt;&gt;&gt; lambda;

<span class="nc bnc" id="L88" title="All 4 branches missed.">			if (thenV instanceof DataSet &amp;&amp; elseV instanceof DataSet) // Two datasets</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">				lambda = dc -&gt; ((DataSet) ((Boolean) dc.get(booleanConditionMeasure).get() ? thenV : elseV))</span>
<span class="nc" id="L90">						.getMatching(dc.getValues(keys, Identifier.class))</span>
<span class="nc" id="L91">						.findFirst()</span>
<span class="nc" id="L92">						.get()</span>
<span class="nc" id="L93">						.getValues(NonIdentifier.class);</span>
			else // One dataset and one scalar
			{
<span class="nc bnc" id="L96" title="All 2 branches missed.">				DataSet dataset = ((DataSet) (thenV instanceof DataSet ? thenV : elseV));</span>
<span class="nc" id="L97">				Map&lt;? extends DataStructureComponent&lt;? extends NonIdentifier, ?, ?&gt;, ? extends ScalarValue&lt;?, ?, ?&gt;&gt; scalar = ((VTLDataSetMetadata) metadata)</span>
<span class="nc" id="L98">						.getComponents(NonIdentifier.class).stream()</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">						.collect(toMapWithValues(k -&gt; (ScalarValue&lt;?, ?, ?&gt;) (thenV instanceof ScalarValue ? thenV : elseV)));</span>

<span class="nc bnc" id="L101" title="All 4 branches missed.">				lambda = dc -&gt; (BOOLEANDS.cast(dc.get(booleanConditionMeasure)).get() ^ thenV != dataset)</span>
						// condition true and 'then' is a dataset or condition false and 'else' is a dataset 
<span class="nc" id="L103">						? dataset.getMatching(dc.getValues(keys, Identifier.class))</span>
<span class="nc" id="L104">								.findFirst()</span>
<span class="nc" id="L105">								.get()</span>
<span class="nc" id="L106">								.getValues(NonIdentifier.class)</span>
<span class="nc" id="L107">						: scalar;</span>
			}

<span class="nc" id="L110">			return condD.mapKeepingKeys((VTLDataSetMetadata) metadata, lambda);</span>
		}
	}

	@Override
	public boolean isTerminal()
	{
<span class="nc" id="L117">		return false;</span>
	}

	@Override
	public Set&lt;LeafTransformation&gt; getTerminals()
	{
<span class="nc" id="L123">		return concat(condition.getTerminals().stream(), </span>
<span class="nc" id="L124">				concat(thenExpr.getTerminals().stream(), elseExpr.getTerminals().stream()))</span>
<span class="nc" id="L125">					.collect(toSet());</span>
	}

	@Override
	public VTLValueMetadata getMetadata(TransformationScheme session)
	{
<span class="nc" id="L131">		VTLValueMetadata meta = condition.getMetadata(session);</span>
<span class="nc" id="L132">		VTLValueMetadata left = thenExpr.getMetadata(session);</span>
<span class="nc" id="L133">		VTLValueMetadata right = elseExpr.getMetadata(session);</span>

<span class="nc bnc" id="L135" title="All 4 branches missed.">		if (meta instanceof VTLScalarValueMetadata &amp;&amp; ((VTLScalarValueMetadata&lt;?&gt;) meta).getDomain() instanceof BooleanDomainSubset)</span>
<span class="nc bnc" id="L136" title="All 4 branches missed.">			if (left instanceof ScalarValue &amp;&amp; right instanceof ScalarValue)</span>
<span class="nc" id="L137">				return metadata = left;</span>
			else
<span class="nc" id="L139">				throw new UnsupportedOperationException(&quot;Incompatible types in conditional expression: &quot; + left + &quot;, &quot; + right);</span>
<span class="nc bnc" id="L140" title="All 6 branches missed.">		else if (meta instanceof VTLDataSetMetadata &amp;&amp; (left instanceof VTLDataSetMetadata || right instanceof VTLDataSetMetadata))</span>
		{
<span class="nc" id="L142">			Set&lt;? extends DataStructureComponent&lt;?, ?, ?&gt;&gt; measures = ((VTLDataSetMetadata) meta).getComponents(Measure.class, Domains.BOOLEANDS);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">			VTLDataSetMetadata dataset = (VTLDataSetMetadata) (left instanceof VTLDataSetMetadata ? left : right);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">			VTLValueMetadata other = left instanceof VTLDataSetMetadata ? right : left;</span>

<span class="nc bnc" id="L146" title="All 2 branches missed.">			if (measures.size() != 1)</span>
<span class="nc" id="L147">				throw new VTLExpectedComponentException(Measure.class, Domains.BOOLEANDS, measures);</span>

<span class="nc bnc" id="L149" title="All 2 branches missed.">			if (!dataset.getComponents(Identifier.class).equals(((VTLDataSetMetadata) meta).getComponents(Identifier.class)))</span>
<span class="nc" id="L150">				throw new UnsupportedOperationException(&quot;Condition must have same identifiers as other expressions: &quot; + dataset.getComponents(Identifier.class) + &quot; -- &quot; + ((VTLDataSetMetadata) meta).getComponents(Identifier.class));</span>

<span class="nc bnc" id="L152" title="All 2 branches missed.">			if (other instanceof VTLDataSetMetadata)</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">				if (!dataset.equals(other))</span>
				{
<span class="nc" id="L155">					Set&lt;DataStructureComponent&lt;?, ?, ?&gt;&gt; missing = new HashSet&lt;&gt;(dataset);</span>
<span class="nc" id="L156">				    missing.addAll((VTLDataSetMetadata) other);</span>
<span class="nc" id="L157">				    Set&lt;DataStructureComponent&lt;?, ?, ?&gt;&gt; tmp = new HashSet&lt;&gt;(dataset);</span>
<span class="nc" id="L158">				    tmp.retainAll((VTLDataSetMetadata) other);</span>
<span class="nc" id="L159">				    missing.removeAll(tmp);</span>
				    
<span class="nc bnc" id="L161" title="All 2 branches missed.">				    if (!dataset.containsAll(missing))</span>
				    {
<span class="nc" id="L163">				    	missing.removeAll(dataset);</span>
<span class="nc" id="L164">				    	throw new VTLSyntaxException(&quot;Then and Else expressions must have the same structure.&quot;, new VTLMissingComponentsException(missing, dataset)); </span>
				    }
				    else
				    {
<span class="nc" id="L168">				    	missing.removeAll((VTLDataSetMetadata) other);</span>
<span class="nc" id="L169">				    	throw new VTLSyntaxException(&quot;Then and Else expressions must have the same structure.&quot;, new VTLMissingComponentsException(missing, (VTLDataSetMetadata) other));</span>
				    }
				}
				else
					;
<span class="nc" id="L174">			else if (!dataset.getComponents(Measure.class).stream()</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">					.allMatch(c -&gt; ((VTLScalarValueMetadata&lt;?&gt;) other).getDomain().isAssignableFrom(c.getDomain())))</span>
<span class="nc" id="L176">				throw new UnsupportedOperationException(&quot;All measures must be assignable from &quot; + ((VTLScalarValueMetadata&lt;?&gt;) other).getDomain() + &quot;: &quot; + dataset.getComponents(Measure.class));</span>

<span class="nc" id="L178">			return metadata = dataset;</span>
		}
		else
<span class="nc" id="L181">			throw new UnsupportedOperationException(&quot;Unsupported conditional expression form.&quot;);</span>
	}
	
	@Override
	public String toString()
	{
<span class="nc" id="L187">		return &quot;IF &quot; + condition + &quot; THEN &quot; + thenExpr + &quot; ELSE &quot; + elseExpr;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>