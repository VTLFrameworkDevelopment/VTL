<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BetweenTransformation.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">vtl-transform</a> &gt; <a href="index.source.html" class="el_package">it.bancaditalia.oss.vtl.impl.transform.ops</a> &gt; <span class="el_source">BetweenTransformation.java</span></div><h1>BetweenTransformation.java</h1><pre class="source lang-java linenums">package it.bancaditalia.oss.vtl.impl.transform.ops;

import static it.bancaditalia.oss.vtl.impl.types.domain.Domains.BOOLEAN;
import static it.bancaditalia.oss.vtl.impl.types.domain.Domains.BOOLEANDS;
import static java.util.Collections.singletonMap;

import java.util.Set;

import it.bancaditalia.oss.vtl.impl.types.data.BooleanValue;
import it.bancaditalia.oss.vtl.impl.types.data.NullValue;
import it.bancaditalia.oss.vtl.impl.types.dataset.DataStructureComponentImpl;
import it.bancaditalia.oss.vtl.impl.types.dataset.DataStructureImpl.Builder;
import it.bancaditalia.oss.vtl.impl.types.exceptions.VTLIncompatibleTypesException;
import it.bancaditalia.oss.vtl.model.data.ComponentRole.Identifier;
import it.bancaditalia.oss.vtl.model.data.ComponentRole.Measure;
import it.bancaditalia.oss.vtl.model.data.DataSet;
import it.bancaditalia.oss.vtl.model.data.DataSet.VTLDataSetMetadata;
import it.bancaditalia.oss.vtl.model.data.DataStructureComponent;
import it.bancaditalia.oss.vtl.model.data.ScalarValue;
import it.bancaditalia.oss.vtl.model.data.VTLValue;
import it.bancaditalia.oss.vtl.model.data.VTLValue.VTLValueMetadata;
import it.bancaditalia.oss.vtl.model.data.ValueDomainSubset;
import it.bancaditalia.oss.vtl.model.domain.BooleanDomain;
import it.bancaditalia.oss.vtl.model.domain.BooleanDomainSubset;
import it.bancaditalia.oss.vtl.model.transform.Transformation;
import it.bancaditalia.oss.vtl.model.transform.TransformationScheme;

public class BetweenTransformation extends UnaryTransformation
{
	private static final long serialVersionUID = 1L;
<span class="nc" id="L31">	private static final DataStructureComponent&lt;Measure, BooleanDomainSubset, BooleanDomain&gt; BOOL_MEASURE = new DataStructureComponentImpl&lt;&gt;(&quot;bool_var&quot;, Measure.class, BOOLEANDS);</span>
	
	private final ScalarValue&lt;?, ?, ?&gt; from;
	private final ScalarValue&lt;?, ?, ?&gt; to;
	private final ValueDomainSubset&lt;?&gt; domain;

	private VTLDataSetMetadata metadata;

	public BetweenTransformation(Transformation operand, Transformation fromT, Transformation toT)
	{
<span class="nc" id="L41">		super(operand);</span>
		
<span class="nc bnc" id="L43" title="All 4 branches missed.">		if (fromT instanceof ConstantOperand &amp;&amp; toT instanceof ConstantOperand)</span>
		{
<span class="nc" id="L45">			this.from = ((ConstantOperand&lt;?, ?, ?, ?&gt;) fromT).eval(null);</span>
<span class="nc" id="L46">			this.to = ((ConstantOperand&lt;?, ?, ?, ?&gt;) toT).eval(null);</span>
		}
		else
<span class="nc" id="L49">			throw new UnsupportedOperationException(&quot;Non-constant range parameters in between expression are not supported&quot;);</span>
		
<span class="nc bnc" id="L51" title="All 4 branches missed.">		if (!from.getDomain().isAssignableFrom(to.getDomain()) || !to.getDomain().isAssignableFrom(from.getDomain()))</span>
<span class="nc" id="L52">			throw new VTLIncompatibleTypesException(&quot;between&quot;, from, to);</span>
<span class="nc bnc" id="L53" title="All 4 branches missed.">		if (from instanceof NullValue || to instanceof NullValue)</span>
<span class="nc" id="L54">			throw new NullPointerException(&quot;Between: Null constant not allowed.&quot;);</span>
<span class="nc" id="L55">		this.domain = from.getDomain(); </span>
<span class="nc" id="L56">	}</span>

	@Override
	public VTLValueMetadata getMetadata(TransformationScheme scheme)
	{
<span class="nc" id="L61">		VTLValueMetadata op = operand.getMetadata(scheme);</span>

<span class="nc bnc" id="L63" title="All 2 branches missed.">		if (op instanceof VTLDataSetMetadata)</span>
		{
<span class="nc" id="L65">			VTLDataSetMetadata ds = (VTLDataSetMetadata) op;</span>

<span class="nc" id="L67">			Set&lt;? extends DataStructureComponent&lt;? extends Measure, ?, ?&gt;&gt; measures = ds.getComponents(Measure.class);</span>

<span class="nc bnc" id="L69" title="All 2 branches missed.">			if (measures.size() != 1)</span>
<span class="nc" id="L70">				throw new UnsupportedOperationException(&quot;Expected single measure but found: &quot; + measures);</span>

<span class="nc" id="L72">			DataStructureComponent&lt;? extends Measure, ?, ?&gt; measure = measures.iterator().next();</span>

<span class="nc bnc" id="L74" title="All 2 branches missed.">			if (!measure.getDomain().isAssignableFrom(domain))</span>
<span class="nc" id="L75">				throw new VTLIncompatibleTypesException(&quot;between&quot;, measure, domain);</span>

<span class="nc" id="L77">			return metadata = new Builder()</span>
<span class="nc" id="L78">					.addComponents(ds.getComponents(Identifier.class))</span>
<span class="nc" id="L79">					.addComponent(BOOL_MEASURE)</span>
<span class="nc" id="L80">					.build();</span>
		}
		else
<span class="nc" id="L83">			return BOOLEAN;</span>
	}

	@Override
	protected ScalarValue&lt;?, ?, ?&gt; evalOnScalar(ScalarValue&lt;?, ?, ?&gt; scalar)
	{
<span class="nc bnc" id="L89" title="All 6 branches missed.">		return scalar instanceof NullValue ? NullValue.instance(BOOLEANDS) : BooleanValue.of(scalar.compareTo(from) &gt;= 0 &amp;&amp; scalar.compareTo(to) &lt;= 0);</span>
	}

	@Override
	protected VTLValue evalOnDataset(DataSet dataset)
	{
<span class="nc" id="L95">		DataStructureComponent&lt;? extends Measure, ?, ?&gt; measure = dataset.getComponents(Measure.class).iterator().next();</span>
<span class="nc" id="L96">		return dataset.mapKeepingKeys(metadata, dp -&gt; singletonMap(BOOL_MEASURE, evalOnScalar(dp.get(measure))));</span>
	}
	
	@Override
	public String toString()
	{
<span class="nc" id="L102">		return &quot;between(&quot; + operand + &quot;, &quot; + from + &quot;, &quot; + to + &quot;)&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>